<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Menu QR Pro - Äáº·t MÃ³n & Theo DÃµi</title>
  <style>
    :root { 
        --primary: #d32f2f; 
        --bg: #f8f9fa;
        --success: #2e7d32;
        font-family: 'Segoe UI', Roboto, sans-serif;
    }
    body { margin: 0; background: var(--bg); padding-bottom: 50px; color: #333; }
    header { background: white; border-bottom: 2px solid var(--primary); padding: 15px 0; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .wrap { max-width: 600px; margin: 0 auto; padding: 0 15px; }
    .topbar { display: flex; justify-content: space-between; align-items: center; }
    .brand { font-size: 20px; font-weight: 800; color: var(--primary); }
    
    .card { background: white; border-radius: 15px; padding: 20px; margin-top: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    h2 { font-size: 17px; margin: 0 0 15px 0; border-left: 4px solid var(--primary); padding-left: 10px; }
    .card.history-card { border-left: 4px solid var(--success); background: #f1f8e9; }

    /* Menu Items */
    .item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
    .item-name { font-weight: 600; display: block; }
    .item-price { color: var(--primary); font-weight: 700; font-size: 14px; }

    /* Quantity Controls */
    .qty-box { display: flex; align-items: center; gap: 10px; background: #f1f1f1; border-radius: 8px; padding: 3px; }
    .btn-qty { width: 30px; height: 30px; border: none; border-radius: 6px; background: white; cursor: pointer; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .qty-num { font-weight: 700; min-width: 15px; text-align: center; }

    /* Preview & History */
    .list-box { margin-bottom: 10px; font-size: 14px; }
    .list-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #ddd; }
    
    textarea { width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 10px; box-sizing: border-box; margin: 10px 0; font-family: inherit; }
    
    .btn-order { background: #1a1a1a; color: white; width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; }
    .btn-order:disabled { background: #ccc; }

    .status-badge { font-size: 12px; background: var(--success); color: white; padding: 2px 8px; border-radius: 10px; float: right; }
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">ğŸ  NHÃ€ HÃ€NG DELI</div>
      <div style="background: #eee; padding: 5px 12px; border-radius: 20px; font-size: 13px;">BÃ n: <b id="displayTable">---</b></div>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="card">
    <h2>ğŸ´ Thá»±c Ä‘Æ¡n</h2>
    <div id="menuContent"></div>
  </div>

  <div class="card">
    <h2>ğŸ›’ MÃ³n Ä‘ang chá»n</h2>
    <div id="cartPreview" class="list-box">ChÆ°a chá»n mÃ³n nÃ o...</div>
    <div style="text-align: right; font-weight: bold;">Tá»•ng Ä‘Æ¡n má»›i: <span id="totalPrice" style="color: var(--primary);">0â‚«</span></div>
    <textarea id="orderNote" rows="2" placeholder="Ghi chÃº thÃªm..."></textarea>
    <button id="submitBtn" class="btn-order" onclick="sendToTelegram()">XÃC NHáº¬N Äáº¶T MÃ“N</button>
  </div>

  <div id="historyContainer" class="card history-card" style="display: none;">
    <h2>âœ… MÃ³n Ä‘Ã£ Ä‘áº·t (Äang chá» phá»¥c vá»¥)</h2>
    <div id="orderHistory" class="list-box"></div>
    <div style="text-align: right; font-size: 13px; color: #555; margin-top: 10px;">
        <i>LÆ°u Ã½: Náº¿u cáº§n há»§y mÃ³n, vui lÃ²ng gá»i nhÃ¢n viÃªn.</i>
    </div>
  </div>
</main>

<script>
  const TG_TOKEN = "8428955430:AAEvZ_8fM0yVbw7RiQ2XLuWcud3Bl48Hi48";
  const TG_CHAT_ID = "1533009941";

  const MENU = [
    { id: 1, name: "Phá»Ÿ BÃ² TÃ¡i", price: 45000 },
    { id: 2, name: "Phá»Ÿ GÃ  Ta", price: 45000 },
    { id: 3, name: "BÃºn BÃ² Huáº¿", price: 50000 },
    { id: 4, name: "CÃ  PhÃª Sá»¯a", price: 25000 },
    { id: 5, name: "NÆ°á»›c Cam Ã‰p", price: 30000 }
  ];

  let cart = {};
  // Láº¥y lá»‹ch sá»­ mÃ³n Ä‘Ã£ Ä‘áº·t tá»« bá»™ nhá»› trÃ¬nh duyá»‡t
  let historyOrders = JSON.parse(localStorage.getItem('ordered_items') || "[]");

  const params = new URLSearchParams(location.search);
  const table = params.get("table") || "Mang vá»";
  document.getElementById("displayTable").innerText = table;

  function renderMenu() {
    document.getElementById("menuContent").innerHTML = MENU.map(item => {
      const qty = cart[item.id] || 0;
      return `
      <div class="item">
        <div><span class="item-name">${item.name}</span><span class="item-price">${item.price.toLocaleString()}â‚«</span></div>
        <div class="qty-box">
          <button class="btn-qty" onclick="changeQty(${item.id}, -1)">-</button>
          <span class="qty-num">${qty}</span>
          <button class="btn-qty" onclick="changeQty(${item.id}, 1)">+</button>
        </div>
      </div>`;
    }).join("");
  }

  function changeQty(id, delta) {
    cart[id] = (cart[id] || 0) + delta;
    if (cart[id] <= 0) delete cart[id];
    renderMenu();
    renderPreview();
  }

  function renderPreview() {
    const previewDiv = document.getElementById("cartPreview");
    let total = 0;
    const entries = Object.entries(cart);
    if (entries.length === 0) {
      previewDiv.innerHTML = "ChÆ°a chá»n mÃ³n nÃ o...";
      document.getElementById("totalPrice").innerText = "0â‚«";
      return;
    }
    let html = "";
    entries.forEach(([id, qty]) => {
      const item = MENU.find(m => m.id == id);
      total += item.price * qty;
      html += `<div class="list-item"><span>${item.name} x${qty}</span><span>${(item.price * qty).toLocaleString()}â‚«</span></div>`;
    });
    previewDiv.innerHTML = html;
    document.getElementById("totalPrice").innerText = total.toLocaleString() + "â‚«";
  }

  // HÃ m hiá»ƒn thá»‹ lá»‹ch sá»­ cÃ¡c mÃ³n Ä‘Ã£ gá»­i Ä‘i
  function renderHistory() {
    const historyDiv = document.getElementById("orderHistory");
    const container = document.getElementById("historyContainer");
    
    if (historyOrders.length === 0) {
      container.style.display = "none";
      return;
    }

    container.style.display = "block";
    historyDiv.innerHTML = historyOrders.map(item => `
      <div class="list-item" style="border-bottom: 1px solid #c8e6c9;">
        <span><b>${item.name}</b> x${item.qty}</span>
        <span style="font-size: 11px; color: #666;">${item.time}</span>
      </div>
    `).reverse().join(""); // Äáº£o ngÆ°á»£c Ä‘á»ƒ mÃ³n má»›i nháº¥t hiá»‡n lÃªn Ä‘áº§u
  }

  async function sendToTelegram() {
    if (Object.keys(cart).length === 0) return alert("Vui lÃ²ng chá»n mÃ³n!");
    const btn = document.getElementById("submitBtn");
    btn.disabled = true;

    let text = `ğŸ”” <b>ÄÆ N HÃ€NG Má»šI</b>\nğŸ“ <b>BÃ n:</b> ${table}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
    const currentTime = new Date().toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'});
    
    Object.entries(cart).forEach(([id, qty]) => {
      const item = MENU.find(m => m.id == id);
      text += `â€¢ ${item.name} x${qty}\n`;
      // LÆ°u vÃ o lá»‹ch sá»­ cá»¥c bá»™
      historyOrders.push({ name: item.name, qty: qty, time: currentTime });
    });

    text += `â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’° <b>Tá»•ng: ${document.getElementById("totalPrice").innerText}</b>\nğŸ“ <b>Ghi chÃº:</b> ${document.getElementById("orderNote").value || "KhÃ´ng"}`;

    try {
      const res = await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ chat_id: TG_CHAT_ID, text: text, parse_mode: "HTML" })
      });
      if ((await res.json()).ok) {
        alert("âœ… ÄÃ£ gá»­i Ä‘Æ¡n hÃ ng thÃ nh cÃ´ng!");
        // LÆ°u lá»‹ch sá»­ vÃ o localStorage
        localStorage.setItem('ordered_items', JSON.stringify(historyOrders));
        cart = {}; 
        document.getElementById("orderNote").value = "";
        renderMenu(); renderPreview(); renderHistory();
      }
    } catch (e) { alert("Lá»—i gá»­i Ä‘Æ¡n!"); }
    finally { btn.disabled = false; }
  }

  // Khá»Ÿi táº¡o trang
  renderMenu();
  renderHistory();
</script>
</body>
</html>
